# PRD: Mandatory Browser-Based Validation for Frontend Projects

## Status: DRAFT
## Author: Generated by AI, owned by human
## Date: 2026-02-28

---

## 1. Problem Statement

The dev-pipeline validates frontend projects at the code and API level but never launches a real browser. This creates three specific validation gaps:

1. **Smoke test (execute.md Step 5d/5e)** makes HTTP requests and performs static CSS analysis. A page returning HTTP 200 with completely broken rendering passes validation.
2. **E2E tests (test.md Step 4)** are optional. The `test_commands.e2e` entry is commented out by default, and there is no enforcement that tests use a real browser engine.
3. **Designer Critic** performs pure static code review, checking code patterns but never inspecting rendered output.

**Result:** Projects pass every pipeline check in theory but break in the browser. Frontend regressions (blank pages, broken layouts, console errors, invisible elements) ship undetected.

**Why now:** The pipeline already supports frontend projects via `has_frontend: true`, designer critic, and smoke testing. These features create a false sense of validation coverage. Adding browser-based verification closes the gap with minimal incremental complexity, since Playwright provides a headless browser with built-in screenshot APIs and ships its own Chromium binary.

## 2. Target Users

| User | Benefit |
|------|---------|
| **Pipeline operators** (developers running `fullpipeline` or `execute` on frontend projects) | Confidence that a passing pipeline means the app actually renders correctly in a browser |
| **Pipeline maintainers** (contributors to dev-pipeline itself) | Clear, testable contracts for when browser validation runs, what it captures, and how fallback works |
| **QA engineers / reviewers** | Screenshot evidence attached to every pipeline run — visual proof of rendering, not just code assertions |

Non-frontend project users are **completely unaffected** — all changes are gated behind `has_frontend: true`.

## 3. Goals

- **G1:** When `has_frontend: true`, the pipeline must launch a real headless browser during smoke testing (execute.md Step 5d/5e), verify pages render without JavaScript errors, and capture multi-viewport screenshots as evidence.
- **G2:** E2E browser tests must be mandatory (not optional) for frontend projects. Missing E2E configuration must be flagged as a Critical failure in the test stage.
- **G3:** The Designer Critic must require screenshot evidence from browser rendering when reviewing code for frontend projects, preventing a PASS verdict without proof of actual browser rendering.
- **G4:** Non-frontend projects (`has_frontend: false`) must experience zero behavioral changes.
- **G5:** When Playwright is not installed, the pipeline must fall back gracefully to existing static-only validation with explicit Warning messages, never hard-failing due to a missing optional tool.

## 4. Non-Goals (Explicitly Out of Scope)

- **Visual regression testing** (screenshot comparison against baselines) — deferred to a future iteration. The current value is "does it render at all?", not "does it match the previous version?"
- **Cross-browser testing** — only Chromium is used. Safari/Firefox/WebKit testing is out of scope.
- **Performance profiling in the browser** (Lighthouse scores, Core Web Vitals) — the pipeline captures rendering correctness, not performance metrics.
- **Real user interaction replay** — smoke test simulates basic flows (click, type, navigate), not full recorded user sessions.
- **Automatic Playwright installation without user consent** — `auto_install` defaults to `false`; the pipeline prompts during `pipeline-init`.
- **Mobile device emulation beyond viewport sizing** — no touch event simulation, device pixel ratio emulation, or network throttling.
- **Screenshot storage or archival** — screenshots are cleaned and regenerated each run. No history, no S3 upload, no artifact retention beyond the local `.pipeline/screenshots/` directory.

## 5. User Stories

### US-1: Browser-Based Smoke Test During Execute
**As a** pipeline operator running `execute` on a frontend project, **I want** the smoke test (Step 5d/5e) to launch a real headless browser and verify my app renders correctly, **so that** a page returning HTTP 200 with broken rendering does not falsely pass.

**Acceptance Criteria:**
- [ ] AC 1.1: When `has_frontend: true` and Playwright is available, Step 5d navigates to the entry URL in headless Chromium instead of making HTTP-only requests.
- [ ] AC 1.2: Step 5d captures all `console.error` events during page load and asserts count <= `max_console_errors` (default: 0).
- [ ] AC 1.3: Step 5d verifies key DOM elements are visible (root element `#root`/`#__next`/`#app`/`main`, navigation, content area).
- [ ] AC 1.4: When `smoke_test.interaction_endpoint` is set, Step 5d simulates user flow via Playwright actions (click, type, navigate) instead of HTTP requests.
- [ ] AC 1.5: When `has_frontend: false`, Step 5d uses the existing HTTP-only behavior with zero changes.
- [ ] AC 1.6: When `has_frontend: true` but Playwright is not available, Step 5d falls back to HTTP-only with a Warning message including installation instructions.

### US-2: Multi-Viewport Screenshot Capture
**As a** pipeline operator, **I want** the smoke test (Step 5e) to capture screenshots at mobile (375x812), tablet (768x1024), and desktop (1280x720) viewports for each discovered route, **so that** I have visual evidence that the app renders correctly across screen sizes.

**Acceptance Criteria:**
- [ ] AC 2.1: Step 5e captures screenshots at 3 viewports (mobile 375x812, tablet 768x1024, desktop 1280x720) for each route.
- [ ] AC 2.2: Screenshots are saved to `screenshot_dir` (default `.pipeline/screenshots/`) as `{route-slug}_{viewport}.png`.
- [ ] AC 2.3: The screenshot directory is cleaned (`rm -rf && mkdir -p`) at the start of each run to prevent disk bloat. The directory path must be validated as a relative path within the project (not `/`, `~`, or containing `..`). The default `.pipeline/screenshots/` is always safe.
- [ ] AC 2.4: Route discovery auto-detects routes from the framework (Next.js App Router `app/**/page.tsx`, Pages Router `pages/**/*.tsx` excluding `_app/_document/api/`, SvelteKit `src/routes/**/+page.svelte`, generic SPA entry-only). The entry URL is always included.
- [ ] AC 2.5: Auto-detected routes are capped at `max_routes` (default: 10). Config `smoke_test_routes` overrides auto-detection.
- [ ] AC 2.6: When Playwright is not available, Step 5e runs only static analysis (CSS vars, asset references, dark theme) with a Warning.

### US-3: DOM and Rendering Verification
**As a** pipeline operator, **I want** Step 5e to verify DOM correctness and responsive behavior in the browser, **so that** broken layouts and error states are caught before they ship.

**Acceptance Criteria:**
- [ ] AC 3.1: Step 5e verifies a non-empty `<title>` or `<h1>` exists.
- [ ] AC 3.2: Step 5e verifies the main content area is visible (height > 0).
- [ ] AC 3.3: Step 5e detects error overlays (`[data-nextjs-dialog]`, `.error-boundary`) and fails if present.
- [ ] AC 3.4: Step 5e verifies images are loaded (naturalWidth > 0 for `<img>` elements).
- [ ] AC 3.5: At mobile viewport, Step 5e asserts no horizontal overflow (`scrollWidth <= clientWidth`).
- [ ] AC 3.6: At mobile viewport, Step 5e asserts no text is rendered below 12px font size.
- [ ] AC 3.7: Existing static analysis checks (CSS vars, asset references, dark theme) continue to run as supplementary validation alongside browser checks.

### US-4: Mandatory E2E Tests for Frontend Projects
**As a** pipeline operator running `test` on a frontend project, **I want** E2E browser tests to be mandatory, **so that** I cannot skip browser-level testing on a project that renders in a browser.

**Acceptance Criteria:**
- [ ] AC 4.1: In test.md Step 2, when `has_frontend: true` and `test_commands.e2e` is not configured, the inventory table shows a Critical finding: "E2E browser tests are mandatory for frontend projects."
- [ ] AC 4.2: In test.md Step 4, when `has_frontend: true`, E2E is listed as "Mandatory" (not "Only if configured").
- [ ] AC 4.3: When `has_frontend: true` and E2E is not configured, the test report shows FAIL (not SKIP).
- [ ] AC 4.4: The fix subagent scaffolds a minimal Playwright E2E test and configures `test_commands.e2e` when E2E is missing.
- [ ] AC 4.5: When `has_frontend: false`, E2E remains optional ("only if configured").

### US-5: Designer Critic Browser Evidence Requirement
**As a** pipeline reviewer, **I want** the Designer Critic to require screenshot evidence from browser rendering when reviewing frontend code, **so that** a code review cannot pass without proof that the UI actually renders.

**Acceptance Criteria:**
- [ ] AC 5.1: designer-critic.md has a "Browser Verification Evidence" checklist section for code review (not PRD review).
- [ ] AC 5.2: The section checks for screenshot existence in `.pipeline/screenshots/`, coverage of 3 viewports, zero console errors, no error overlays, and interaction screenshots if applicable.
- [ ] AC 5.3: When `has_frontend: true`, no screenshots exist, and Playwright was available, the Designer Critic raises a Critical finding.
- [ ] AC 5.4: When `has_frontend: true` but Playwright was not available, missing screenshots are downgraded to a Warning.
- [ ] AC 5.5: The Designer Critic output format includes a "Browser Verification Evidence" checklist block.

### US-6: Pipeline Configuration for Browser Testing
**As a** pipeline maintainer, **I want** the config template to include a `browser_testing` section and uncommented E2E test command, **so that** frontend projects have clear, discoverable configuration for browser validation.

**Acceptance Criteria:**
- [ ] AC 6.1: `pipeline-config-template.yaml` contains a `browser_testing` section (commented out, matching existing pattern) with fields for: tool, headless, screenshot_dir, viewports, smoke_test_routes, max_routes, max_console_errors, visual_regression, auto_install.
- [ ] AC 6.2: The `browser_testing` section is placed after the `smoke_test` section and before `test_stage`.
- [ ] AC 6.3: `test_commands.e2e` is uncommented in the template with value `"npx playwright test"` and annotated as mandatory when `has_frontend: true`.
- [ ] AC 6.4: Default values are documented inline (headless: true, screenshot_dir: ".pipeline/screenshots", 3 viewport sizes, max_routes: 10, max_console_errors: 0, visual_regression: false, auto_install: false).

### US-7: Playwright Onboarding During Pipeline Init
**As a** developer initializing the pipeline for a frontend project, **I want** `pipeline-init` to detect Playwright and offer installation, **so that** I can set up browser testing with minimal friction.

**Acceptance Criteria:**
- [ ] AC 7.1: When `has_frontend: true`, pipeline-init Step 3 checks if `@playwright/test` is in `devDependencies`.
- [ ] AC 7.2: If Playwright is found, `test_commands.e2e` is auto-set to the detected command or default `"npx playwright test"`.
- [ ] AC 7.3: If Playwright is not found, the user is presented with options: install now (`npm install -D @playwright/test && npx playwright install chromium`) or skip for now.
- [ ] AC 7.4: If the user installs, the generated config uncomments the `browser_testing` section and sets `test_commands.e2e`.
- [ ] AC 7.5: If the user skips, a note is added explaining that static fallback will be used with Warning-level findings.

### US-8: Pipeline Reports and Documentation Updates
**As a** pipeline operator, **I want** the completion report and workflow documentation to reflect browser validation, **so that** I know what was validated and where to find evidence.

**Acceptance Criteria:**
- [ ] AC 8.1: The fullpipeline.md completion report includes a "Browser screenshots" row in the Smoke Test table (PASS/N/A, timing, route x viewport count).
- [ ] AC 8.2: WORKFLOW.md Stage 4 Step 5 description mentions browser validation when `has_frontend: true`.

### US-9: Structural Validation Tests
**As a** pipeline maintainer, **I want** structural validation tests to verify browser validation content exists in all modified files, **so that** accidental regressions in pipeline file content are caught by CI.

**Acceptance Criteria:**
- [ ] AC 9.1: Test verifies `execute.md` contains "Playwright" and browser verification paths.
- [ ] AC 9.2: Test verifies `execute.md` Step 5e references the 3 viewport widths (375, 768, 1280).
- [ ] AC 9.3: Test verifies `execute.md` Step 5e has a static analysis fallback path.
- [ ] AC 9.4: Test verifies `designer-critic.md` has a "Browser Verification Evidence" section.
- [ ] AC 9.5: Test verifies `designer-critic.md` references `.pipeline/screenshots/`.
- [ ] AC 9.6: Test verifies `test.md` Step 2 flags missing E2E as Critical for frontend.
- [ ] AC 9.7: Test verifies `test.md` Step 4 marks E2E as mandatory for frontend.
- [ ] AC 9.8: Test verifies the config template has a `browser_testing` section.
- [ ] AC 9.9: Test verifies the config template has an uncommented `e2e` in `test_commands`.

## 6. Functional Requirements

### Must Have (P0)

- **FR-1:** Browser-based smoke test in execute.md Step 5d — navigate entry URL in headless Chromium, capture console errors, verify DOM elements. (US-1)
- **FR-2:** Multi-viewport screenshot capture in execute.md Step 5e — 3 viewports per route, saved to `.pipeline/screenshots/`, directory cleaned each run. (US-2)
- **FR-3:** DOM and rendering verification in execute.md Step 5e — title/h1, content visibility, error overlay detection, image loading, responsive overflow and font-size checks. (US-3)
- **FR-4:** Auto-detection of routes from framework conventions (Next.js, SvelteKit, generic SPA) capped at `max_routes`. (US-2)
- **FR-5:** Mandatory E2E for frontend — test.md Step 2 flags missing E2E as Critical, Step 4 marks E2E as mandatory when `has_frontend: true`. (US-4)
- **FR-6:** Graceful fallback — when Playwright is not installed, all browser-dependent steps fall back to existing HTTP/static behavior with explicit Warning messages. (US-1, US-2, US-3)
- **FR-7:** Non-frontend isolation — all browser-specific behavior gated behind `has_frontend: true`. Zero changes for non-frontend projects. (US-1 through US-9)
- **FR-8:** Designer Critic "Browser Verification Evidence" section — requires screenshots for code review pass when `has_frontend: true`. (US-5)
- **FR-9:** `browser_testing` config section in pipeline-config-template.yaml with all documented defaults. (US-6)
- **FR-10:** Uncommented `e2e` test command in pipeline-config-template.yaml, annotated as mandatory for frontend. (US-6)

### Should Have (P1)

- **FR-11:** Playwright onboarding in pipeline-init — auto-detect, offer install, configure. (US-7)
- **FR-12:** Fix subagent scaffolds minimal Playwright E2E test when E2E is missing for frontend projects. (US-4)
- **FR-13:** fullpipeline.md completion report includes "Browser screenshots" row. (US-8)
- **FR-14:** WORKFLOW.md updated to mention browser validation for frontend. (US-8)
- **FR-15:** Console error aggregation across all page loads with configurable threshold via `max_console_errors`. (US-1, US-3)

### Nice to Have (P2)

- **FR-16:** Structural validation tests in test-stage-structure.test.js covering all 9 content assertions. (US-9)
- **FR-17:** Support for custom `smoke_test_routes` override in config. (US-2)
- **FR-18:** `auto_install: true` option for CI environments to auto-install Playwright browsers. (US-6)

## 7. Acceptance Criteria (Consolidated)

### P0 — Must Pass for Launch

- [ ] AC 1.1: Browser navigation replaces HTTP-only for frontend smoke test when Playwright available
- [ ] AC 1.2: Console errors captured and asserted against `max_console_errors` threshold
- [ ] AC 1.3: DOM element visibility verified (root, nav, content)
- [ ] AC 1.4: Interaction flow via Playwright when `interaction_endpoint` set
- [ ] AC 1.5: Non-frontend projects use existing HTTP-only behavior unchanged
- [ ] AC 1.6: Fallback to HTTP with Warning when Playwright not available
- [ ] AC 2.1: Screenshots at 3 viewports per route
- [ ] AC 2.2: Screenshot naming convention `{route-slug}_{viewport}.png`
- [ ] AC 2.3: Screenshot directory cleaned each run (path validated as safe relative path)
- [ ] AC 2.4: Route auto-detection from framework conventions
- [ ] AC 2.5: Route cap at `max_routes` with config override
- [ ] AC 2.6: Static-only fallback with Warning when no Playwright
- [ ] AC 3.1: Non-empty title or h1 verified
- [ ] AC 3.2: Main content visible (height > 0)
- [ ] AC 3.3: Error overlay detection fails the check
- [ ] AC 3.4: Image load verification
- [ ] AC 3.5: No horizontal overflow at mobile viewport
- [ ] AC 3.6: No text below 12px at mobile viewport
- [ ] AC 3.7: Static analysis continues as supplement
- [ ] AC 4.1: Missing E2E flagged as Critical for frontend in Step 2
- [ ] AC 4.2: E2E listed as "Mandatory" in Step 4 for frontend
- [ ] AC 4.3: Missing E2E shows FAIL not SKIP for frontend
- [ ] AC 4.5: E2E remains optional for non-frontend
- [ ] AC 5.1: Designer Critic has "Browser Verification Evidence" section
- [ ] AC 5.2: Section checks screenshots, viewports, errors, overlays
- [ ] AC 5.3: Missing screenshots + Playwright available = Critical
- [ ] AC 5.4: Missing screenshots + Playwright unavailable = Warning
- [ ] AC 5.5: Output format includes browser evidence checklist
- [ ] AC 6.1: Config template has `browser_testing` section with all fields
- [ ] AC 6.2: `browser_testing` placed after `smoke_test`, before `test_stage`
- [ ] AC 6.3: `test_commands.e2e` uncommented with annotation
- [ ] AC 6.4: Default values documented inline

### P1 — Should Pass

- [ ] AC 4.4: Fix subagent scaffolds minimal Playwright E2E test
- [ ] AC 7.1: pipeline-init checks for `@playwright/test` in devDependencies
- [ ] AC 7.2: Auto-set `test_commands.e2e` when Playwright found
- [ ] AC 7.3: Present install/skip options when Playwright not found
- [ ] AC 7.4: Install flow uncomments `browser_testing` and sets e2e command
- [ ] AC 7.5: Skip flow adds fallback note
- [ ] AC 8.1: Completion report has "Browser screenshots" row
- [ ] AC 8.2: WORKFLOW.md mentions browser validation

### P2 — Nice to Have

- [ ] AC 9.1–9.9: All 9 structural validation tests present and passing

## 8. Non-Functional Requirements

### Performance
- **NFR-1:** Browser-based smoke test (all routes, all viewports) must complete within 120 seconds for up to 10 routes. Route cap (`max_routes`) bounds worst-case duration. Budget breakdown: 10 routes x 3 viewports x ~3s per screenshot = ~90s navigation/capture + ~30s overhead (browser launch, route discovery, console aggregation).
- **NFR-2:** Screenshot capture per viewport must complete within 3 seconds per page (including navigation and render wait). Per-page timeout of 30 seconds catches hangs without blocking the pipeline.
- **NFR-3:** Static analysis fallback path must have zero performance regression versus current behavior.

### Reliability
- **NFR-4:** Playwright availability detection (`npx playwright --version`) must be deterministic — no flaky detection based on PATH or node_modules state.
- **NFR-5:** Screenshot directory cleanup must not fail if the directory does not exist (idempotent `rm -rf && mkdir -p`).

### Compatibility
- **NFR-6:** All changes must be backward-compatible. Existing `pipeline.config.yaml` files without a `browser_testing` section must continue to work with sensible defaults.
- **NFR-7:** Playwright is the only supported browser automation tool. No abstraction layer for future tools (YAGNI).

### Maintainability
- **NFR-8:** Every browser-specific code path must have a `has_frontend: true` guard. Grep for `has_frontend` must find guards on every browser section.
- **NFR-9:** Every Playwright-dependent section must have a "Playwright not available" fallback with Warning-level messaging.

### Disk & Resource Usage
- **NFR-10:** Screenshots cleaned each run. No cumulative disk growth across pipeline runs.
- **NFR-11:** Headless Chromium used exclusively (`headless: true` default). No display server (X11/Wayland) required. `xvfb` not needed.

## 9. Testing Strategy

| User Story | Unit | Integration | E2E | Structural | Notes |
|-----------|------|-------------|-----|------------|-------|
| US-1 (Browser Smoke) | N/A | N/A | N/A | Yes | Structural tests verify execute.md content contains Playwright paths |
| US-2 (Screenshots) | N/A | N/A | N/A | Yes | Structural tests verify viewport widths in execute.md |
| US-3 (DOM Verify) | N/A | N/A | N/A | Yes | Structural tests verify fallback path exists |
| US-4 (Mandatory E2E) | N/A | N/A | N/A | Yes | Structural tests verify test.md content |
| US-5 (Designer Critic) | N/A | N/A | N/A | Yes | Structural tests verify designer-critic.md content |
| US-6 (Config) | N/A | N/A | N/A | Yes | Structural tests verify config template content |
| US-7 (Init) | N/A | N/A | N/A | No | Manual verification during pipeline-init run |
| US-8 (Reports) | N/A | N/A | N/A | No | Visual inspection of updated docs |
| US-9 (Tests) | N/A | N/A | N/A | Self | Tests validate themselves by passing `npm test` |

**Rationale:** This project modifies pipeline instruction files (Markdown) and configuration templates (YAML), not runtime application code. The primary automated validation is structural tests that assert expected content exists in the correct files. No unit or integration tests apply because there is no executable code being written — only pipeline instructions consumed by LLM agents.

**Manual verification checklist:**
1. Run full pipeline on a frontend project with Playwright installed — verify screenshots generated, browser checks pass.
2. Run full pipeline on a frontend project without Playwright — verify fallback to static analysis with Warnings.
3. Run full pipeline on a non-frontend project — verify zero behavioral changes.
4. Run `pipeline-init` on a frontend project — verify Playwright detection and onboarding prompt.

## 10. Technical Context & Constraints

### Architecture
- **dev-pipeline** is a CLI pipeline tool. It consists of Markdown instruction files (consumed by LLM agents), YAML configuration templates, and JavaScript structural tests.
- There is no runtime application server, database, or API. Changes are to pipeline instruction documents and templates.
- The pipeline itself is not a frontend project: `has_frontend: false`, `has_backend_service: false`, `has_api: false`.

### Dependencies
- **Playwright** (`@playwright/test`) is the chosen browser automation tool. It is a dependency of projects that use the pipeline, not of the pipeline itself.
- Playwright was chosen over Cypress (requires display server) and Puppeteer (no built-in test runner, no screenshot API) because it runs headless by default, ships its own Chromium, and has native screenshot and console-capture APIs.
- The pipeline does not install Playwright. It detects it and uses it if available, or falls back gracefully.

### Constraints
- All browser-specific instructions must be gated behind `has_frontend: true` — no exceptions.
- Playwright is the only supported tool. No abstraction layer or plugin system.
- Visual regression (screenshot diffing) is explicitly deferred — no baseline infrastructure exists.
- Screenshots are ephemeral (cleaned each run). No cross-run persistence or artifact upload.
- The `auto_install` flag defaults to `false`. The pipeline must never install software without explicit user configuration.

### Files Modified (7 files)
1. `pipeline/templates/pipeline-config-template.yaml` — config section + e2e uncomment
2. `commands/execute.md` — Steps 5d, 5e, 6 for browser validation
3. `pipeline/agents/designer-critic.md` — Browser Verification Evidence section
4. `commands/test.md` — Steps 2, 4 for mandatory E2E
5. `commands/pipeline-init.md` — Playwright onboarding
6. `commands/fullpipeline.md` + `WORKFLOW.md` — report and docs updates
7. `test/test-stage-structure.test.js` — structural validation tests

## 11. Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|--------------------|
| Browser rendering gaps caught | 100% of pages with broken rendering fail the smoke test | Manual audit: run pipeline on known-broken frontend, verify failure |
| False pass rate for frontend projects | 0% (no frontend project passes execute stage with broken rendering) | Run pipeline against test projects with injected rendering bugs |
| Non-frontend regression | 0 behavioral changes | Run pipeline against non-frontend project, diff output against baseline |
| Fallback reliability | 100% graceful fallback when Playwright absent | Run pipeline on frontend project without Playwright installed |
| Screenshot coverage | N routes x 3 viewports = 3N screenshots per run | Count files in `.pipeline/screenshots/` after run |

### Tracking & Analytics Events

N/A — metrics measured via manual pipeline runs and structural test assertions. The dev-pipeline is a CLI tool with no client-side tracking, analytics SDK, or telemetry. All success metrics are verified through pipeline output inspection and test suite results.

## 12. Open Questions

- [ ] **OQ-1:** Should the pipeline support viewport configuration override per-route (e.g., admin pages at desktop-only), or are the 3 fixed viewports sufficient for all routes?
- [ ] **OQ-2:** What is the appropriate wait strategy for screenshots — `networkidle`, `domcontentloaded`, or a fixed timeout? Different frameworks have different hydration patterns.
- [ ] **OQ-3:** Should Playwright browser installation be version-pinned in the config template (e.g., `chromium@1234`), or always use `latest`?
- [ ] **OQ-4:** For SPA frameworks with client-side routing, should route discovery navigate to routes via the browser (click links) or via direct URL navigation? The former catches routing bugs; the latter is faster.
- [ ] **OQ-5:** Should console.warn events be captured in addition to console.error? Some frameworks emit important warnings (e.g., React hydration mismatches) that indicate rendering issues.

## 13. Dependencies & Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Playwright not installed on target project | Med — fallback to static analysis with Warnings, reduced validation coverage | High — many projects may not have Playwright | Graceful fallback path + pipeline-init onboarding prompt + clear installation instructions in Warning messages |
| Playwright version incompatibility across projects | Low — Playwright API used is stable (page.goto, screenshot, evaluate) | Low — core API rarely breaks | Use only stable, well-documented Playwright APIs. No version-specific features. |
| Headless Chromium crashes or hangs during screenshot capture | Med — blocks pipeline completion | Low — Chromium headless is mature and stable | Set per-page timeout (30s). Catch navigation errors. Continue to next route on failure. Report as Warning, not hard failure. |
| Route auto-detection misidentifies files as routes | Low — extra screenshots, slight time increase | Med — framework conventions vary | Cap at `max_routes`. Allow `smoke_test_routes` config override. Entry URL always included as baseline. |
| Screenshot directory cleanup deletes user data | High — data loss | Very Low — directory is well-scoped to `.pipeline/screenshots/` | Only clean the configured `screenshot_dir` path. Never use `~` or `/` as screenshot dir. Validate path starts with `.pipeline/` or is a relative path within the project. |
| CI environments lack Chromium dependencies (e.g., missing shared libraries) | Med — Playwright fails to launch | Med — common in minimal Docker images | Document CI setup requirements. `auto_install: true` option installs Chromium with deps. Fallback to static analysis if launch fails. |
| Large number of routes exceeds timeout | Med — slow pipeline run | Low — capped at 10 by default | `max_routes` config with default of 10. Timeout per page of 30 seconds. Total budget of 120 seconds for 10 routes x 3 viewports. |

## 14. Timeline Estimate

- **Phase 1 (Core — P0):** Config template + execute.md browser paths + test.md mandatory E2E + designer-critic evidence section + fallback paths. Estimated: 1 implementation session.
- **Phase 2 (Onboarding — P1):** pipeline-init Playwright detection + fix subagent scaffolding + report/doc updates. Estimated: 1 implementation session.
- **Phase 3 (Tests — P2):** Structural validation tests + verification across all modified files. Estimated: 0.5 implementation session.

**Total estimate:** 2.5 implementation sessions (each session = one `execute` pipeline run with critic review).
