# PRD: Make dev-pipeline a Portable Claude Code Plugin

## Status: DRAFT
## Author: Generated by AI, owned by human
## Date: 2026-02-25

---

## 1. Problem Statement

The dev-pipeline repository has 8 command files that reference agents and templates via hardcoded `~/.claude/pipeline/` paths. This only works locally because a symlink (`~/.claude/pipeline → dev-pipeline/pipeline/`) is manually created. Anyone installing dev-pipeline as a Claude Code plugin cannot use it without this manual setup — the plugin is not portable.

We need to add a plugin manifest and replace all hardcoded paths with the `${CLAUDE_PLUGIN_ROOT}` variable so the plugin works out-of-the-box when installed through Claude Code's plugin system.

## 2. Target Users

- **New users** installing dev-pipeline as a Claude Code plugin from the marketplace — they expect it to work without manual symlink setup.
- **Existing users** who currently use the symlink method — plugin compatibility maintains backward compatibility while offering a cleaner install path.
- **Contributors** who clone the repo and want to test commands locally.

## 3. Goals

- All command files use `${CLAUDE_PLUGIN_ROOT}/pipeline/` instead of `~/.claude/pipeline/` (zero hardcoded home-directory paths remaining)
- A valid `.claude-plugin/plugin.json` manifest exists so Claude Code recognizes the repo as a plugin
- README documents the plugin installation method as the recommended approach
- Zero breaking changes — existing symlink-based installs continue to work

## 4. Non-Goals (Explicitly Out of Scope)

- Changing command behavior or pipeline logic — this is purely a path portability change. **Exception:** the `plan2jira.md` script/env resolution order changes from sibling-directory-first to plugin-root-first (FR-4/FR-5). This is an intentional simplification, not a logic change — the old sibling-directory paths were artifacts of the pre-plugin layout and are being replaced with the canonical plugin path.
- Adding new commands, agents, or templates
- Modifying the JIRA integration logic beyond fixing path resolution
- Publishing to a plugin marketplace (only adding the manifest and install instructions)
- Adding automated tests for path resolution (manual verification is sufficient for this scope)
- Changing the `ask.md` command (it has no `~/.claude/pipeline/` references)

## 5. User Stories

Each user story includes inline acceptance criteria.

### US-1: Plugin manifest enables Claude Code recognition
**As a** Claude Code user, **I want** the dev-pipeline repo to have a valid plugin manifest, **so that** Claude Code recognizes it as an installable plugin.

**Acceptance Criteria:**
- [ ] AC 1.1: `.claude-plugin/plugin.json` exists at the repository root with valid JSON containing `name`, `version`, `description`, `author`, `repository`, `license`, and `keywords` fields
- [ ] AC 1.2: The `name` field is `"dev-pipeline"` and `version` is `"1.0.0"`

### US-2: Commands resolve paths via plugin root variable
**As a** user who installed dev-pipeline as a plugin, **I want** all commands to reference templates and agents via `${CLAUDE_PLUGIN_ROOT}/pipeline/`, **so that** paths resolve correctly without manual symlinks.

**Acceptance Criteria:**
- [ ] AC 2.1: `grep -r '~/.claude/pipeline/' commands/ WORKFLOW.md` returns zero results
- [ ] AC 2.2: All 7 command files (`req2prd.md`, `prd2plan.md`, `plan2jira.md`, `execute.md`, `validate.md`, `fullpipeline.md`, `pipeline-init.md`) use `${CLAUDE_PLUGIN_ROOT}/pipeline/` for agent and template paths
- [ ] AC 2.3: `WORKFLOW.md` uses `${CLAUDE_PLUGIN_ROOT}/pipeline/` for its template references

### US-3: JIRA script resolution uses plugin-aware paths
**As a** user running `/plan2jira`, **I want** the script and env file resolution to use plugin-aware paths, **so that** JIRA integration works without sibling-directory assumptions.

**Acceptance Criteria:**
- [ ] AC 3.1: `plan2jira.md` resolves `jira-import.js` first from `${CLAUDE_PLUGIN_ROOT}/scripts/jira/jira-import.js`, with `scripts/jira/jira-import.js` (current project) as override
- [ ] AC 3.2: `plan2jira.md` resolves `.env.jira` from project root first, then `${CLAUDE_PLUGIN_ROOT}/.env.jira` as fallback
- [ ] AC 3.3: `grep -r '../dev-pipeline/' commands/` returns zero results
- [ ] AC 3.4: `grep -r '../cursor-pipeline-template/' commands/` returns zero results
- [ ] AC 3.5: `plan2jira.md` does NOT create or write `.env.jira` inside `${CLAUDE_PLUGIN_ROOT}/` — if interactive credential setup exists, it must write to the project root only (Manual Scenario D)

### US-4: README documents plugin installation
**As a** new user, **I want** the README to explain how to install dev-pipeline as a Claude Code plugin, **so that** I can get started without reading source code.

**Acceptance Criteria:**
- [ ] AC 4.1: README contains an "As a Claude Code Plugin (recommended)" installation section
- [ ] AC 4.2: README retains the existing symlink installation method labeled as "Manual (symlink — legacy)"

### US-5: Runtime verification in both install modes
**As a** developer merging this change, **I want** to verify commands resolve paths correctly at runtime in both plugin and symlink install modes, **so that** the backward compatibility guarantee is proven, not just asserted.

**Acceptance Criteria:**
- [ ] AC 5.1: When installed as a plugin, running `/req2prd` with a test requirement successfully loads the PRD template from `${CLAUDE_PLUGIN_ROOT}/pipeline/templates/prd-template.md`
- [ ] AC 5.2: When installed via symlink, running `/req2prd` with a test requirement successfully loads the PRD template (confirming `${CLAUDE_PLUGIN_ROOT}` resolves through the symlink chain)
- [ ] AC 5.3: Positive-path count verification: `grep -rc 'CLAUDE_PLUGIN_ROOT' commands/` shows at least 27 total occurrences across the 7 command files (confirming all replacements landed correctly, not just that old paths are gone)

## 6. Functional Requirements

### Must Have (P0)

- FR-1: Create `.claude-plugin/plugin.json` with required manifest fields (name, version, description, author, repository, license, keywords). The `repository` field points to the public GitHub repo (`https://github.com/ydaromai/dev-pipeline`) — no private-URL disclosure concern.
- FR-2: Replace all `~/.claude/pipeline/` references with `${CLAUDE_PLUGIN_ROOT}/pipeline/` across 7 command files (27 path replacements total)
- FR-3: Replace `~/.claude/pipeline/` references in `WORKFLOW.md` (1 replacement)
- FR-4: Rewrite `plan2jira.md` script resolution (lines 13-26) to use `${CLAUDE_PLUGIN_ROOT}/scripts/jira/jira-import.js` as default, with project-local `scripts/jira/jira-import.js` as override
- FR-5: Rewrite `plan2jira.md` env file resolution to use project-root `.env.jira` first, `${CLAUDE_PLUGIN_ROOT}/.env.jira` as fallback. If neither file exists, the natural file-not-found error serves as a clear error (no special error-handling code needed — this is the same graceful failure pattern as Section 8 NFR). The `.env.jira` file MUST remain gitignored — the plugin-root fallback is for local development convenience only; credentials must never be committed to the repository.
- FR-6: Remove all `../dev-pipeline/` and `../cursor-pipeline-template/` legacy path references from `plan2jira.md`

### Should Have (P1)

- FR-7: Add plugin installation instructions to `README.md` as the recommended method
- FR-8: Retain symlink installation instructions in `README.md` labeled as legacy

### Nice to Have (P2)

- (None — this is a focused portability change)

## 7. Acceptance Criteria (Consolidated)

Master checklist of all acceptance criteria for easy reference and tracking.

### P0 — Must Pass for Launch
- [ ] AC 1.1: `.claude-plugin/plugin.json` exists with valid JSON and required fields
- [ ] AC 1.2: Manifest name is `"dev-pipeline"`, version is `"1.0.0"`
- [ ] AC 2.1: `grep -r '~/.claude/pipeline/' commands/ WORKFLOW.md` returns zero results
- [ ] AC 2.2: All 7 command files use `${CLAUDE_PLUGIN_ROOT}/pipeline/` for agent/template paths
- [ ] AC 2.3: `WORKFLOW.md` uses `${CLAUDE_PLUGIN_ROOT}/pipeline/` for template references
- [ ] AC 3.1: `plan2jira.md` resolves `jira-import.js` via plugin root with project-local override
- [ ] AC 3.2: `plan2jira.md` resolves `.env.jira` from project root first, plugin root as fallback
- [ ] AC 3.3: `grep -r '../dev-pipeline/' commands/` returns zero results
- [ ] AC 3.4: `grep -r '../cursor-pipeline-template/' commands/` returns zero results
- [ ] AC 3.5: `plan2jira.md` does NOT write `.env.jira` to `${CLAUDE_PLUGIN_ROOT}/` (Manual Scenario D)

### P0 — Runtime Verification (blocking for merge)
- [ ] AC 5.1: Plugin install: `/req2prd` successfully loads PRD template from plugin root (Manual Scenario A)
- [ ] AC 5.2: Symlink install: `/req2prd` successfully loads PRD template through symlink (Manual Scenario B)
- [ ] AC 5.3: Positive count: `grep -rc 'CLAUDE_PLUGIN_ROOT' commands/` totals >= 27

### P1 — Should Pass
- [ ] AC 4.1: README contains plugin installation section marked as recommended
- [ ] AC 4.2: README retains symlink method labeled as legacy

### P2 — Nice to Have
- (None)

## 8. Non-Functional Requirements

- **Backward compatibility:** Existing symlink-based installs must continue to work. The `${CLAUDE_PLUGIN_ROOT}` variable is resolved by Claude Code's plugin system; for symlink installs, Claude Code sets `${CLAUDE_PLUGIN_ROOT}` to the resolved directory (following symlinks). Verification: run at least one command via symlink install and confirm agent/template resolution succeeds (AC 5.2).
- **No logic changes:** All modifications are path string replacements — `git diff` should show only path substitutions with no added conditionals, no new control flow, and no new function calls. Exception: `plan2jira.md` resolution order simplification (documented in Section 4).
- **Idempotency:** Applying the changes twice produces no additional diff. Verifiable: after applying, `git diff` shows no changes.
- **Graceful failure:** If `${CLAUDE_PLUGIN_ROOT}` is undefined or empty in a given context, the command should fail with a clear file-not-found error pointing the user to install the plugin or set up the symlink. This is the natural behavior — an unresolved variable in a `Read` path will produce a file-not-found error. No special fallback mechanism is needed.
- **Credential safety:** The `.env.jira` file must remain in `.gitignore`. The plugin-root fallback for `.env.jira` (FR-5) is for local development only. Credentials must never be committed to the plugin repository.

## 9. Testing Strategy

Define required test types per user story. These override/extend the project defaults in `pipeline.config.yaml`.

| User Story | Unit | Integration | UI | E2E | Notes |
|-----------|------|-------------|-----|-----|-------|
| US-1 | No | No | No | No | Manual: validate JSON with `cat .claude-plugin/plugin.json \| python3 -m json.tool` |
| US-2 | No | No | No | No | Negative: `grep -r '~/.claude/pipeline/' commands/ WORKFLOW.md` returns 0 results. Positive: `grep -rc 'CLAUDE_PLUGIN_ROOT' commands/` totals >= 27 |
| US-3 | No | No | No | No | `grep -r '../dev-pipeline/' commands/` and `grep -r '../cursor-pipeline-template/' commands/` both return 0 results |
| US-4 | No | No | No | No | Visual review of README installation section |
| US-5 | No | No | No | Manual | Runtime smoke test in both install modes (see manual E2E scenarios below) |

### Manual E2E Verification Scenarios

These structured manual tests verify runtime path resolution. They should be run before merging.

**Scenario A — Plugin install:**
1. Install the plugin: add the repo as a Claude Code plugin
2. Run `/req2prd` with a short test requirement (e.g., "Add a hello world endpoint")
3. **Expected:** Command loads `prd-template.md` from the plugin's `pipeline/templates/` directory without error
4. **Pass if:** PRD generation starts (template was found). **Fail if:** "file not found" error on the template path.

**Scenario B — Symlink install:**
1. Set up symlinks: `ln -s <repo>/commands ~/.claude/commands && ln -s <repo>/pipeline ~/.claude/pipeline`
2. Run `/req2prd` with a short test requirement
3. **Expected:** Command loads `prd-template.md` through the symlink chain. Note: Claude Code sets `${CLAUDE_PLUGIN_ROOT}` to the resolved symlink target directory automatically — the variable still resolves in symlink mode.
4. **Pass if:** PRD generation starts. **Fail if:** "file not found" error.

**Scenario C — Missing install (negative test):**
1. Remove both plugin and symlink installations
2. Run `/req2prd`
3. **Expected:** Clear file-not-found error referencing the `${CLAUDE_PLUGIN_ROOT}` path
4. **Pass if:** Error message helps user understand they need to install the plugin. **Fail if:** Silent failure or cryptic error.

**Scenario D — `plan2jira` missing `.env.jira` (negative test for JIRA fallback):**
1. Ensure no `.env.jira` exists in either the project root or `${CLAUDE_PLUGIN_ROOT}/`
2. Run `/plan2jira` with a valid dev plan
3. **Expected:** Clear error indicating `.env.jira` was not found in either location. The command should NOT offer to create `.env.jira` inside `${CLAUDE_PLUGIN_ROOT}/` (credentials must only be created in the project root).
4. **Pass if:** Error message references both lookup locations and stops. **Fail if:** Silent failure, or credentials are written to the plugin directory.

No automated test code is needed — all verification is via grep commands, JSON validation, and structured manual smoke tests.

## 10. Technical Context & Constraints

- **`${CLAUDE_PLUGIN_ROOT}`** is a variable resolved by Claude Code at runtime. It points to the root of the installed plugin directory. When the repo is installed as a plugin, this resolves to the plugin's install location. For symlink installs, Claude Code sets this variable to the resolved symlink target directory. The variable is resolved **before** command text is processed and sent to subagents — so references like `Read ${CLAUDE_PLUGIN_ROOT}/pipeline/agents/product-critic.md` in embedded critic prompts will resolve correctly.
- **Trust boundary:** `${CLAUDE_PLUGIN_ROOT}` is set by the Claude Code runtime, not by user input. It is trusted as a safe path prefix.
- **Files affected:** 7 command files in `commands/`, plus `README.md` and `WORKFLOW.md`. One new file: `.claude-plugin/plugin.json`.
- **No new dependencies** are introduced.
- **The `ask.md` command** is the only command file that does not reference `~/.claude/pipeline/` and requires no changes.
- **Path types in commands:** Most of the 27 path references are direct file-read instructions (e.g., "Read `~/.claude/pipeline/templates/prd-template.md`"). Some are in instructional/prose text within `validate.md` (e.g., "All relevant critic agent files from `~/.claude/pipeline/agents/`") and in embedded subagent prompt strings within `plan2jira.md`. All should be replaced uniformly — the variable resolves before any text is sent to subagents.
- **Branch:** All work on `feat/plugin-compat`.

## 11. Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|--------------------|
| Hardcoded paths eliminated | 0 remaining `~/.claude/pipeline/` refs in commands/ + WORKFLOW.md | `grep -r '~/.claude/pipeline/' commands/ WORKFLOW.md` returns empty |
| Legacy paths eliminated | 0 remaining `../dev-pipeline/` and `../cursor-pipeline-template/` refs | `grep -r '../dev-pipeline/' commands/` and `grep -r '../cursor-pipeline-template/' commands/` return empty |
| Plugin manifest valid | Valid JSON with all required fields | `python3 -m json.tool .claude-plugin/plugin.json` exits 0 |
| Positive replacement count | >= 27 `CLAUDE_PLUGIN_ROOT` refs in commands/ | `grep -rc 'CLAUDE_PLUGIN_ROOT' commands/` totals >= 27 |
| Runtime resolution (plugin) | `/req2prd` loads template without error | Manual Scenario A |
| Runtime resolution (symlink) | `/req2prd` loads template without error | Manual Scenario B |

### Tracking & Analytics Events

N/A — this is a developer tooling change with no client-side tracking. Metrics are measured via grep commands at verification time.

## 12. Open Questions

- [x] **Resolved:** Does `${CLAUDE_PLUGIN_ROOT}` resolve in all command execution contexts, including subagent spawns via the Task tool? **Answer:** Yes — Claude Code resolves plugin variables before processing command text. This is verified by Manual Scenario A (plugin install) which exercises the full command execution path including any subagent prompts.
- [x] **Resolved:** Does `${CLAUDE_PLUGIN_ROOT}` resolve correctly for symlink-based installs? **Answer:** Yes — Claude Code sets the variable to the resolved symlink target. Verified by Manual Scenario B.
- [ ] **Open:** Does `plugin.json` support a `permissions` or `capabilities` field for least-privilege scoping? If so, the manifest should declare minimum required permissions. **Action:** Check Claude Code plugin docs before implementation; if supported, add permissions to FR-1.

## 13. Dependencies & Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| `${CLAUDE_PLUGIN_ROOT}` variable not supported in all Claude Code contexts | High — commands would fail to find agents/templates | Low — this is a documented Claude Code plugin feature | Verify variable resolution in a test plugin install before merging |
| Existing symlink users need to update | Med — could break their setup temporarily | Low — `${CLAUDE_PLUGIN_ROOT}` resolves correctly through symlinks | Document both install methods in README; symlink path continues to work |
| Missing a hardcoded path reference | Med — one command would fail for plugin users | Low — grep verification catches all instances | Run verification grep commands (negative + positive count) as final check before merge |
| Dual install conflict (plugin + symlink coexist) | Low — confusing but not breaking | Low — unusual setup | `${CLAUDE_PLUGIN_ROOT}` takes precedence; document that users should use one method, not both |

## 14. Timeline Estimate

- Phase 1: All changes in a single PR on `feat/plugin-compat` branch — estimated effort is minimal (path replacements + 1 new JSON file + README update)

## 15. Rollback Plan

If the change is merged and causes issues:
1. **Immediate rollback:** `git revert <merge-commit>` on main — restores all hardcoded paths. Single-PR change makes revert clean.
2. **No data migration needed** — this change has no state, no database, no configuration files that persist beyond the command files themselves.
3. **User impact during rollback:** Symlink users are unaffected (revert restores their paths). Plugin users would need to wait for a fix or fall back to symlink install.
