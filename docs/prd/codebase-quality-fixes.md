# PRD: Dev-Pipeline Codebase Quality Fixes

## Status: DRAFT
## Author: Generated by AI, owned by human
## Date: 2026-02-18

---

## 1. Problem Statement

The dev-pipeline codebase was reviewed by all 5 critic agents (Product, Dev, DevOps, QA, Security). All 5 returned FAIL verdicts, identifying 16+ critical findings across security, code quality, module consistency, and test coverage. The pipeline enforces quality on downstream projects but does not meet its own standards. These issues must be fixed to ensure the pipeline itself is reliable, secure, and self-consistent.

## 2. Target Users

- **Pipeline developers**: Maintaining and extending the dev-pipeline tooling
- **Pipeline users**: Engineers using `/fullpipeline`, `/plan2jira`, `/execute` in their projects

## 3. Goals

- All JIRA scripts run without module system errors
- Credentials are never accidentally committed to git
- Environment variable naming is consistent across all scripts
- Scripts handle malformed input gracefully without crashes
- Command files accurately reflect the current 5-critic system
- Core parsing logic has automated test coverage

## 4. Non-Goals (Explicitly Out of Scope)

- Adding new pipeline features or commands
- Refactoring the JIRA client architecture (beyond removing dead code)
- Adding integration tests that require a live JIRA instance
- Changing the pipeline workflow or critic agent behavior

## 5. User Stories

### US-1: Secure Credential Handling
**As a** pipeline user, **I want** credentials and generated files excluded from git, **so that** API tokens and import artifacts are never accidentally committed.

**Acceptance Criteria:**
- [ ] AC 1.1: `.gitignore` includes `.env.jira`, `jira-issue-mapping.json`, `.jira-import-history.json`, and `node_modules`
- [ ] AC 1.2: `.env.example` file exists at `scripts/jira/.env.example` with placeholder values
- [ ] AC 1.3: Hardcoded `|| 'MVP'` fallback removed from `jira-import.js` config
- [ ] AC 1.4: JIRA API token is never included in error messages logged to console

### US-2: Consistent Module System
**As a** developer, **I want** all scripts to use ES Modules consistently, **so that** scripts run without import/require errors and can share code.

**Acceptance Criteria:**
- [ ] AC 2.1: `scripts/jira/package.json` exists with `"type": "module"`
- [ ] AC 2.2: `transition-issue.js` uses ESM (`import`/`export`) instead of CommonJS
- [ ] AC 2.3: Dead `lib/jira-client.js` (CommonJS, uses uninstalled `axios`) is removed
- [ ] AC 2.4: All scripts in `scripts/jira/` can be executed with `node <script>` without module errors

### US-3: Standardized Configuration
**As a** pipeline user, **I want** consistent environment variable names across all scripts, **so that** I only need one `.env.jira` file and setup is error-free.

**Acceptance Criteria:**
- [ ] AC 3.1: All scripts and command files use `JIRA_API_URL` as the primary env var name (not `JIRA_HOST`), including `pipeline-init.md` Step 9
- [ ] AC 3.2: `pipeline-init.md` Step 9 summary lists all 5 critics including Security
- [ ] AC 3.3: `.env.example` uses `JIRA_API_URL` consistently

### US-4: Robust Input Handling
**As a** pipeline user, **I want** scripts to handle edge cases gracefully, **so that** malformed input produces clear errors instead of crashes.

**Acceptance Criteria:**
- [ ] AC 4.1: `--file` argument uses `arg.slice()` instead of `arg.split('=')[1]` to handle paths with `=`
- [ ] AC 4.2: `currentTask` null access is guarded when SUBTASK appears before any TASK
- [ ] AC 4.3: `checkIdempotency` treats empty/unexpected input (Enter key) as cancel, not as bypass

### US-5: Accurate Documentation
**As a** pipeline user, **I want** command files and README to accurately reflect the current system, **so that** I can trust the pipeline documentation.

**Acceptance Criteria:**
- [ ] AC 5.1: `prd2plan.md` Step 6 says "any" critic (not "either" — there are 5 critics)
- [ ] AC 5.2: `scripts/jira/README.md` replaces legacy `bdt`, `dp2j`, `dwc` references with current pipeline commands
- [ ] AC 5.3: `execute.md` resolves `<jira_transition_path>` placeholder using `pipeline.config.yaml` paths

### US-6: Automated Test Coverage
**As a** developer, **I want** unit tests for core parsing and conversion logic, **so that** regressions are caught before they reach JIRA.

**Acceptance Criteria:**
- [ ] AC 6.1: Unit tests exist for `MarkdownParser` in `jira-import.js` covering: happy path (Epic/Story/Task/Subtask), dual format support, null currentTask edge case, empty file input
- [ ] AC 6.2: Unit tests exist for `markdownToADF` covering: headings, bold/italic/code, lists, checkboxes, code blocks, empty input, links
- [ ] AC 6.3: Tests run with `node --test` (Node.js built-in test runner, zero dependencies)
- [ ] AC 6.4: `package.json` includes a `test` script that runs all tests

## 6. Functional Requirements

### Must Have (P0)

- Fix `.gitignore` to exclude credential and generated files
- Create `scripts/jira/package.json` with `"type": "module"`
- Convert `transition-issue.js` from CommonJS to ESM
- Remove dead `lib/jira-client.js`
- Remove hardcoded `|| 'MVP'` project key fallback
- Guard `currentTask` null access in markdown parser
- Fix `--file` argument parsing to handle paths with `=`
- Sanitize API token from error messages
- Fix `checkIdempotency` bypass on empty input

### Should Have (P1)

- Standardize env var to `JIRA_API_URL` everywhere (remove `JIRA_HOST` from transition-issue.js)
- Create `.env.example` with placeholder values
- Fix `pipeline-init.md` summary to include Security Critic
- Fix `prd2plan.md` wording ("either" → "any")
- Update `scripts/jira/README.md` to replace legacy command references
- Add `jira_transition_path` resolution guidance to `execute.md`

### Nice to Have (P2)

- Unit tests for `MarkdownParser`
- Unit tests for `markdownToADF`
- Test script in `package.json`

## 7. Acceptance Criteria (Consolidated)

### P0 — Must Pass for Launch
- [ ] AC 1.1: `.gitignore` covers credentials and generated files
- [ ] AC 1.3: No hardcoded project key fallback
- [ ] AC 1.4: API tokens not in error output
- [ ] AC 2.1: `package.json` with `"type": "module"`
- [ ] AC 2.2: `transition-issue.js` uses ESM
- [ ] AC 2.3: Dead `lib/jira-client.js` removed
- [ ] AC 2.4: All scripts run without module errors
- [ ] AC 4.1: `--file` parsing handles `=` in paths
- [ ] AC 4.2: `currentTask` null guard
- [ ] AC 4.3: `checkIdempotency` empty input fix

### P1 — Should Pass
- [ ] AC 1.2: `.env.example` exists
- [ ] AC 3.1: `JIRA_API_URL` standardized
- [ ] AC 3.2: `pipeline-init.md` includes Security Critic
- [ ] AC 3.3: `.env.example` uses `JIRA_API_URL`
- [ ] AC 5.1: `prd2plan.md` wording fix
- [ ] AC 5.2: README legacy references updated
- [ ] AC 5.3: `execute.md` jira_transition_path resolution

### P2 — Nice to Have
- [ ] AC 6.1: MarkdownParser unit tests
- [ ] AC 6.2: markdownToADF unit tests
- [ ] AC 6.3: Tests use `node --test`
- [ ] AC 6.4: `test` script in package.json

## 8. Non-Functional Requirements

- **Security**: No credentials in git history, no secrets in error output
- **Reliability**: Scripts handle malformed input without crashing
- **Consistency**: Single module system (ESM), single env var naming convention
- **Maintainability**: Dead code removed, documentation accurate

## 9. Testing Strategy

| User Story | Unit | Integration | UI | E2E | Notes |
|-----------|------|-------------|-----|-----|-------|
| US-1 | No | No | No | No | Manual verification of .gitignore |
| US-2 | No | No | No | No | Verify scripts run with `node <script> --help` |
| US-3 | No | No | No | No | Manual verification of env var names |
| US-4 | Yes | No | No | No | Unit tests for parser edge cases |
| US-5 | No | No | No | No | Manual review of documentation |
| US-6 | Yes | No | No | No | Unit tests for MarkdownParser, markdownToADF |

## 10. Technical Context & Constraints

- Node.js >= 18 (uses native `fetch`)
- No external test framework — use `node:test` built-in module
- Scripts live in `scripts/jira/` with a shared `lib/` subdirectory
- Pipeline command files are markdown prompts in `commands/`
- Agent persona files in `pipeline/agents/`

## 11. Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|--------------------|
| Critic findings resolved | 17/17 | Re-run all 5 critics |
| Scripts execute without errors | 100% | `node <script> --help` for each |
| Test pass rate | 100% | `npm test` in scripts/jira/ |
| No credentials in repo | 0 exposed | `git grep` for tokens/passwords |

## 12. Open Questions

- None — all findings are well-defined with clear fix paths

## 13. Dependencies & Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| ESM conversion breaks transition-issue.js | Medium | Low | Straightforward require→import conversion |
| Removing lib/jira-client.js breaks unknown consumers | Low | Low | Grep confirms it's never imported |
| Tests require Node 18+ for node:test | Low | Low | Already required for native fetch |

## 14. Timeline Estimate

- Phase 1: Security & module fixes (P0) — quick wins
- Phase 2: Config & documentation fixes (P1)
- Phase 3: Unit tests (P2)
