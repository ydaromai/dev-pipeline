# PRD: Add /test Pipeline Stage (Stage 5) — Test Verification & Validation

## Status: DRAFT
## Author: Generated by AI, owned by human
## Date: 2026-02-28

---

## 1. Problem Statement

The dev-pipeline currently ends at `/execute` (Stage 4), which includes a per-task smoke test verifying the app starts and responds. However, the pipeline lacks a dedicated test verification stage that:

- **Audits test existence** against all changed files and `test_requirements` patterns from `pipeline.config.yaml`, ensuring no source file ships without its required test types.
- **Runs each test type separately** (unit, component, integration, UI, E2E) and reports per-type pass/fail/skip/duration, rather than a single monolithic "tests pass" signal.
- **Verifies CI/CD pipeline configuration** is complete, active, and consistent with the project's test commands.
- **Tests local deployment end-to-end** after all test PRs are merged, catching regressions introduced by test additions themselves.
- **Iterates until ALL tests pass** in a single green cycle (not just individual test types), ensuring no cross-type regressions.
- **Runs full cumulative-diff critic validation** across all 10 critics on the `main..HEAD` diff, catching cross-cutting issues (e.g., two independently-reviewed tasks creating a combined security gap) that per-task reviews in `/execute` miss.

Without this stage, test gaps, CI misconfigurations, and cross-cutting quality issues are only caught manually or in production. The `/test` stage closes this gap by making comprehensive test verification a first-class pipeline stage with the same Ralph Loop quality guarantees as `/execute`.

## 2. Target Users

- **Pipeline users (developers):** Developers running `/fullpipeline` or `/test` directly to verify their feature branch is fully tested, CI-ready, and critic-approved before merge to production.
- **Pipeline maintainers:** Developers customizing `pipeline.config.yaml` to configure test commands, coverage thresholds, CI audit behavior, and critic settings for their project.

## 3. Goals

1. **G1: Test completeness** — Every changed source file has all required test types (per `test_requirements` patterns and PRD Section 9 Testing Strategy).
2. **G2: Test correctness** — All test types pass in a single green cycle; failures are auto-fixed with the Ralph Loop pattern (max 3 iterations, then escalate).
3. **G3: Coverage visibility** — Per-file coverage for changed files is reported, with configurable thresholds (warning, not blocking).
4. **G4: CI/CD health** — CI pipeline configuration is audited for completeness, consistency with `test_commands`, and optionally auto-fixed.
5. **G5: CD awareness** — CD pipeline configuration is audited and reported (report-only, no auto-fix due to high risk).
6. **G6: Post-test deployment verification** — Local smoke test runs after all test PRs merge, verifying nothing broke during test additions.
7. **G7: Cumulative quality** — Full 10-critic validation on the cumulative `main..HEAD` diff catches cross-cutting issues missed by per-task reviews.
8. **G8: Pipeline integration** — `/test` integrates seamlessly as Stage 5 in `/fullpipeline`, with Gate 5 and error recovery.
9. **G9: Configurability** — All behavior is configurable via `pipeline.config.yaml` (`test_stage` section), with sensible defaults.
10. **G10: Idempotent** — `/test` can be re-run any number of times; it scans everything from scratch with no persistent state.

## 4. Non-Goals (Explicitly Out of Scope)

- **NG1:** Modifying the `/execute` stage's per-task smoke test (Step 5 of execute.md) — it remains as-is.
- **NG2:** Adding new critic agents — the existing 10 critics are used; no new critic personas are created.
- **NG3:** Implementing a test runner — `/test` invokes existing test commands from `pipeline.config.yaml`; it does not implement its own test framework.
- **NG4:** Persistent state or databases — `/test` is stateless and idempotent; no new state files are introduced.
- **NG5:** Auto-fixing CD pipeline issues — CD audit is report-only due to high deployment risk.
- **NG6:** Modifying critic persona files — critic `.md` files remain unchanged; `/test` uses them as-is.
- **NG7:** Adding browser-based or visual testing capabilities — `/test` operates via CLI only.
- **NG8:** Changing the JIRA integration or issue transition logic.

## 5. User Stories (with inline AC)

### US-1: Audit test existence for changed files
**As a** developer running `/test`, **I want** the pipeline to scan all changed files against `test_requirements` patterns and PRD Section 9 Testing Strategy, **so that** I know exactly which tests are missing before running the suite.

**Acceptance Criteria:**
- [ ] AC 1.1: `/test` computes the cumulative diff scope via `git diff main..HEAD` and extracts changed source file paths.
- [ ] AC 1.2: Each changed file is matched against `test_requirements` patterns from `pipeline.config.yaml` to determine required test types.
- [ ] AC 1.3: PRD Section 9 Testing Strategy is cross-referenced for feature-specific test requirements.
- [ ] AC 1.4: Test types are categorized: unit, component (if `has_frontend`), integration, UI (if `has_frontend`), E2E.
- [ ] AC 1.5: An inventory table is produced showing: file pattern | required types | found | missing.
- [ ] AC 1.6: If no gaps are found, the audit step reports "No gaps found" and proceeds.
- [ ] AC 1.7: If `git diff main..HEAD` returns an empty diff (no changes), Steps 2-5 are skipped with a message "No changed files detected" and execution proceeds to Step 6 (CI audit) and beyond.
- [ ] AC 1.8: If the dev plan file in `$ARGUMENTS` does not exist, `/test` reports a clear error ("Dev plan file not found: <path>") and exits.

### US-2: Generate missing tests via Ralph Loop
**As a** developer running `/test`, **I want** missing tests to be auto-generated and reviewed, **so that** test gaps are filled without manual effort.

**Acceptance Criteria:**
- [ ] AC 2.1: For each gap found in US-1, a BUILD subagent (opus) is spawned to write missing tests.
- [ ] AC 2.2: Generated tests are reviewed by QA + Dev critics.
- [ ] AC 2.3: The Ralph Loop iterates until critics pass (max 3 iterations).
- [ ] AC 2.4: A PR is created for new tests with a human gate for approval.
- [ ] AC 2.5: If no gaps are found, this step is skipped entirely and reports "SKIPPED — no gaps".

### US-3: Run all tests with per-type reporting
**As a** developer running `/test`, **I want** each test type to run separately with pass/fail/skip/duration reported per type, **so that** I can identify exactly which test category has failures.

**Acceptance Criteria:**
- [ ] AC 3.1: Each test type runs using commands from `pipeline.config.yaml` `test_commands` (unit, integration, UI if `has_frontend`, E2E if configured). If a `test_commands` key is not configured for a type, that type is skipped and reported as "SKIPPED (not configured)".
- [ ] AC 3.2: A final `test_commands.all` run validates the complete suite. Step 4 runs only AFTER Step 3 PRs (if any) are merged, ensuring generated tests are included.
- [ ] AC 3.3: Per-type results are reported: pass count, fail count, skip count, duration.
- [ ] AC 3.4: If ANY test fails, a fix subagent (opus, fresh context) is spawned with failure output.
- [ ] AC 3.5: After a fix, ALL tests re-run (not just the failed type) to catch regressions.
- [ ] AC 3.6: Max 3 fix iterations; then escalate to user with failure details.
- [ ] AC 3.7: The goal is a full green cycle where ALL test types pass in a single run.

### US-4: Verify test coverage for changed files
**As a** developer running `/test`, **I want** coverage data for changed files specifically, **so that** I know if new code meets coverage thresholds.

**Acceptance Criteria:**
- [ ] AC 4.1: Tests run with a coverage flag (auto-detected from framework: `--coverage` for vitest/jest, etc.).
- [ ] AC 4.2: Coverage is compared against `test_stage.coverage_thresholds.lines` (default: 80%).
- [ ] AC 4.3: Per-file coverage is reported for new/modified source files.
- [ ] AC 4.4: Below-threshold coverage is a Warning (not blocking), reported in the final table.

### US-5: Audit CI pipeline configuration
**As a** developer running `/test`, **I want** the CI pipeline to be audited for completeness and consistency, **so that** CI will actually run the right tests when I push.

**Acceptance Criteria:**
- [ ] AC 5.1: CI config files are detected (`.github/workflows/*.yml`, `.gitlab-ci.yml`, `Jenkinsfile`, `.circleci/config.yml`, `azure-pipelines.yml`, `bitbucket-pipelines.yml`). If no recognized CI config is found, report "No CI config detected — configure manually or add your CI system to `test_stage.ci_audit.config_paths`".
- [ ] AC 5.2: Verification checks: all required test jobs active (not commented out), test commands match `pipeline.config.yaml`, dependencies/services configured, build step exists, lint step exists.
- [ ] AC 5.3: If issues are found and `test_stage.ci_audit.fix_commented_jobs` is true, a fix subagent is spawned to uncomment/fix CI config.
- [ ] AC 5.4: Fixes create a PR with a human gate.
- [ ] AC 5.5: A CI health table is reported: job | status | notes.

### US-6: Audit CD pipeline configuration
**As a** developer running `/test`, **I want** CD pipeline configuration to be audited, **so that** I know if deployment is properly configured.

**Acceptance Criteria:**
- [ ] AC 6.1: CD config files are detected (deploy workflows, Dockerfile, docker-compose, etc.).
- [ ] AC 6.2: Verification checks: deploy steps exist for staging (at minimum), post-deploy health check exists, rollback strategy documented, environment-specific configs exist.
- [ ] AC 6.3: CD audit is report-only (no auto-fix) — CD changes are high-risk.
- [ ] AC 6.4: A CD component health table is reported.

### US-7: Verify local deployment after test additions
**As a** developer running `/test`, **I want** a smoke test to run after all test PRs merge, **so that** I know test additions didn't break the application.

**Acceptance Criteria:**
- [ ] AC 7.1: The smoke test uses the same infrastructure as `execute.md` Step 5 (start dev server, health checks, core user flow, teardown).
- [ ] AC 7.2: This runs AFTER the test suite passes and test PRs are merged.
- [ ] AC 7.3: If `smoke_test.enabled` is false, skip and report SKIPPED.

### US-8: Run full cumulative critic validation
**As a** developer running `/test`, **I want** all 10 critics to review the full cumulative diff (`main..HEAD`), **so that** cross-cutting issues between independently-reviewed tasks are caught.

**Acceptance Criteria:**
- [ ] AC 8.1: ALL applicable critics (7 always-on + conditional) run in parallel against the full `main..HEAD` diff.
- [ ] AC 8.2: If any critic FAILs, a fix subagent is spawned, then only the previously failed critics re-validate.
- [ ] AC 8.3: Max 3 fix iterations; then escalate to user.
- [ ] AC 8.4: All critics must PASS before Stage 5 is declared complete.

### US-9: View comprehensive final report
**As a** developer running `/test`, **I want** a comprehensive report with per-section verdicts, **so that** I have a complete picture of test and quality status.

**Acceptance Criteria:**
- [ ] AC 9.1: Report includes: Test Inventory (files audited, gaps found/filled), Test Results (per-type table), Coverage (per-file table, overall %), CI Audit (job health table), CD Audit (component health table), Local Deployment (smoke test results), Critic Validation (critic score table), Overall verdict (PASS/FAIL).
- [ ] AC 9.2: Overall is PASS only if all sections are green; FAIL lists blocking items.

### US-10: Configure /test behavior via pipeline.config.yaml
**As a** pipeline maintainer, **I want** to configure `/test` behavior via a `test_stage` section in `pipeline.config.yaml`, **so that** I can customize thresholds, enable/disable features, and control CI audit behavior.

**Acceptance Criteria:**
- [ ] AC 10.1: `test_stage` section is added to `pipeline-config-template.yaml` with all configurable options.
- [ ] AC 10.2: `test_stage.enabled` (default: true) controls whether Stage 5 runs at all.
- [ ] AC 10.3: `test_stage.coverage_thresholds.lines` (default: 80) sets the coverage threshold.
- [ ] AC 10.4: `test_stage.ci_audit.fix_commented_jobs` (default: false) controls auto-fix behavior.
- [ ] AC 10.5: `test_stage.max_fix_iterations` (default: 3) controls the Ralph Loop max iterations.
- [ ] AC 10.6: `test_commands.e2e` and `test_commands.component` are added to the `test_commands` section with commented-out defaults (e.g., `# e2e: "npm run test:e2e"`, `# component: "npm run test:component"`), following the same pattern as the existing `smoke_test` section. Note: `test_commands.all` already exists as an active key and should not be modified.

### US-11: Integrate /test into /fullpipeline
**As a** developer running `/fullpipeline`, **I want** `/test` to run automatically as Stage 5 after `/execute`, **so that** the full pipeline includes test verification.

**Acceptance Criteria:**
- [ ] AC 11.1: `fullpipeline.md` architecture diagram includes Stage 5 between Stage 4 and Completion.
- [ ] AC 11.2: Orchestrator state includes `test_result: PASS | FAIL | SKIPPED`.
- [ ] AC 11.3: A new Stage 5 section spawns a subagent reading `/test` command instructions.
- [ ] AC 11.4: Gate 5 presents test results and requires user approval.
- [ ] AC 11.5: Completion section references Stage 5 and includes Test Verification in the final report.
- [ ] AC 11.6: Error recovery section includes Stage 5 entry.

### US-12: Skip /test stage when disabled
**As a** pipeline maintainer, **I want** to disable `/test` entirely via `test_stage.enabled: false`, **so that** projects that don't need it can skip it.

**Acceptance Criteria:**
- [ ] AC 12.1: When `test_stage.enabled: false`, `/fullpipeline` skips Stage 5 entirely.
- [ ] AC 12.2: The final report shows Stage 5 as SKIPPED with reason.
- [ ] AC 12.3: Running `/test` directly when `test_stage.enabled: false` prints a message and exits.

## 6. Functional Requirements (P0/P1/P2)

### Must Have (P0)

- **FR-1:** Create `commands/test.md` — 10-step command file following the `.md` command pattern.
- **FR-2:** Step 1 (Read inputs) — Read dev plan, `pipeline.config.yaml`, PRD, `AGENT_CONSTRAINTS.md`; compute `git diff main..HEAD` cumulative diff; extract changed file paths.
- **FR-3:** Step 2 (Test Existence Audit) — Scan changed source files against `test_requirements` patterns; cross-reference PRD Section 9; produce inventory table with file pattern, required types, found, missing.
- **FR-4:** Step 3 (Missing Test Generation) — Ralph Loop for test generation: BUILD subagent (opus) writes tests, REVIEW with QA + Dev critics, max 3 iterations, PR with human gate. Skip if no gaps.
- **FR-5:** Step 4 (Run All Tests) — Run each test type separately using `test_commands`; report per-type pass/fail/skip/duration; fix loop (fresh context subagent, re-run ALL tests after fix, max 3 iterations, escalate). **Sequencing:** Step 3 (Missing Test Generation) PRs must be merged before Step 4 begins, so that generated tests are included in the test run. **Missing commands:** If a `test_commands` key is not configured (e.g., `e2e` is absent), that test type is skipped and reported as "SKIPPED (not configured)" in the per-type table. `test_commands.all` is a newly required key used as the final validation pass after individual types run.
- **FR-6:** Step 9 (Full Critic Validation) — All applicable critics in parallel on cumulative `main..HEAD` diff; fix loop for failed critics (max 3 iterations, escalate).
- **FR-7:** Step 10 (Final Report) — Comprehensive report with per-section verdicts and overall PASS/FAIL.
- **FR-8:** Edit `fullpipeline.md` — Add Stage 5 node in architecture diagram, orchestrator state (`test_result`), Stage 5 section with subagent prompt, Gate 5, Completion section update, Error Recovery entry.
- **FR-9:** Edit `pipeline-config-template.yaml` — Add `test_stage` config section with all options (commented-out with defaults, matching existing documentation style), add `test` to validation stages, add `e2e`, `component`, and `all` (if not present) to `test_commands` as commented-out entries with example values.
- **FR-10:** `test_stage.enabled` flag (default: true) — Controls whether Stage 5 runs.
- **FR-11:** Idempotent execution — No persistent state; re-run scans everything from scratch.

### Should Have (P1)

- **FR-12:** Step 5 (Coverage Verification) — Run tests with coverage flag (auto-detect from framework); compare against `test_stage.coverage_thresholds.lines` (default: 80%); per-file coverage for changed files; below-threshold is Warning (not blocking).
- **FR-13:** Step 6 (CI Pipeline Audit) — Detect CI config files; verify test jobs active, commands match config, build/lint steps exist; optional auto-fix via `test_stage.ci_audit.fix_commented_jobs`.
- **FR-14:** Step 7 (CD Pipeline Audit) — Detect CD config files; verify deploy steps, health checks, rollback strategy; report-only (no auto-fix).
- **FR-15:** Step 8 (Local Deployment Verification) — Re-run smoke test after test PRs merge using same infrastructure as `execute.md` Step 5; skip if `smoke_test.enabled: false`.
- **FR-16:** Edit `WORKFLOW.md` — Update diagrams, tables, error recovery, and references to include Stage 5.
- **FR-17:** Edit `README.md` — Update flow diagram, commands table, quick start, and project structure.

### Nice to Have (P2)

- **FR-18:** Coverage trend tracking — Compare current coverage against previous run (if available) and report delta.
- **FR-19:** Test duration regression detection — Flag tests that take significantly longer than previous runs.
- **FR-20:** Parallel test type execution — Run independent test types in parallel to reduce wall-clock time.

## 7. Acceptance Criteria (Consolidated)

### P0 — Must Pass for Launch

- [ ] AC 1.1: Cumulative diff scope computed via `git diff main..HEAD`.
- [ ] AC 1.2: Changed files matched against `test_requirements` patterns.
- [ ] AC 1.3: PRD Section 9 cross-referenced for feature-specific requirements.
- [ ] AC 1.4: Test types categorized (unit, component, integration, UI, E2E).
- [ ] AC 1.5: Inventory table produced (file pattern | required types | found | missing).
- [ ] AC 1.6: No-gaps case handled gracefully.
- [ ] AC 1.7: Empty diff (no changes) skips Steps 2-5 with message.
- [ ] AC 1.8: Missing dev plan file produces clear error and exits.
- [ ] AC 2.1: BUILD subagent spawned for each gap.
- [ ] AC 2.2: Generated tests reviewed by QA + Dev critics.
- [ ] AC 2.3: Ralph Loop max 3 iterations.
- [ ] AC 2.4: PR created with human gate.
- [ ] AC 2.5: Step skipped if no gaps.
- [ ] AC 3.1: Each test type runs via `test_commands`.
- [ ] AC 3.2: Final `test_commands.all` validates complete suite.
- [ ] AC 3.3: Per-type results reported.
- [ ] AC 3.4: Fix subagent spawned on failure.
- [ ] AC 3.5: ALL tests re-run after fix (not just failed type).
- [ ] AC 3.6: Max 3 fix iterations, then escalate.
- [ ] AC 3.7: Full green cycle required.
- [ ] AC 8.1: All applicable critics run on cumulative diff.
- [ ] AC 8.2: Failed critics trigger fix subagent, re-validate only failed.
- [ ] AC 8.3: Max 3 fix iterations, then escalate.
- [ ] AC 8.4: All critics must PASS.
- [ ] AC 9.1: Comprehensive report with all sections.
- [ ] AC 9.2: Overall PASS/FAIL logic correct.
- [ ] AC 10.1: `test_stage` section in config template.
- [ ] AC 10.2: `test_stage.enabled` controls Stage 5.
- [ ] AC 10.5: `test_stage.max_fix_iterations` configurable.
- [ ] AC 10.6: `e2e`, `component`, and `all` added to `test_commands` (commented-out with example defaults).
- [ ] AC 11.1: Architecture diagram updated.
- [ ] AC 11.2: Orchestrator state updated.
- [ ] AC 11.3: Stage 5 subagent section added.
- [ ] AC 11.4: Gate 5 added.
- [ ] AC 11.5: Completion section updated.
- [ ] AC 11.6: Error recovery updated.
- [ ] AC 12.1: Skip when disabled in fullpipeline.
- [ ] AC 12.2: SKIPPED shown in report.
- [ ] AC 12.3: Direct `/test` exits when disabled.

### P1 — Should Pass for Launch

- [ ] AC 4.1: Coverage flag auto-detected.
- [ ] AC 4.2: Coverage compared against threshold.
- [ ] AC 4.3: Per-file coverage reported.
- [ ] AC 4.4: Below-threshold is Warning.
- [ ] AC 5.1: CI config files detected.
- [ ] AC 5.2: CI verification checks pass.
- [ ] AC 5.3: Auto-fix when configured.
- [ ] AC 5.4: Fix PR with human gate.
- [ ] AC 5.5: CI health table reported.
- [ ] AC 6.1: CD config files detected.
- [ ] AC 6.2: CD verification checks pass.
- [ ] AC 6.3: Report-only (no auto-fix).
- [ ] AC 6.4: CD health table reported.
- [ ] AC 7.1: Smoke test uses execute.md Step 5 infrastructure.
- [ ] AC 7.2: Runs after test suite passes.
- [ ] AC 7.3: Skip when `smoke_test.enabled: false`.
- [ ] AC 10.3: Coverage threshold configurable.
- [ ] AC 10.4: CI auto-fix configurable.

## 8. Non-Functional Requirements

- **NFR-1: Idempotency** — Running `/test` multiple times produces the same results (no persistent state, no side effects beyond git branches and PRs).
- **NFR-2: Fresh context** — `/test` runs as its own subagent in `/fullpipeline` with fresh context; no conversational history carried from prior stages.
- **NFR-3: Escalation safety** — After max iterations, `/test` always escalates to the user rather than silently continuing or failing.
- **NFR-4: Configurability** — All behavioral aspects are configurable via `pipeline.config.yaml` with sensible defaults; unconfigured projects work out of the box.
- **NFR-5: Consistency** — `/test` follows the same `.md` command pattern, Ralph Loop pattern, critic review pattern, PR creation pattern, and human gate pattern as existing stages.
- **NFR-6: Backward compatibility** — Adding `/test` does not break existing pipeline stages or configurations. Projects without a `test_stage` section continue to work as before.
- **NFR-7: Error isolation** — Failures in one step (e.g., CI audit) do not prevent other steps from running (where independent). Blocking failures are clearly identified.
- **NFR-8: Large diff resilience** — Cumulative diffs with 100+ changed files are handled gracefully. Critics run in parallel with per-critic timeout handling (inherited from the existing subagent timeout behavior). If a critic times out, it is reported as "TIMEOUT — escalate" rather than crashing the pipeline.

## 9. Testing Strategy

Since this is a CLI plugin project (`.md` command files + YAML config), testing focuses on structural validation, config schema correctness, and integration with existing stages.

**Structural validation method:** "Structural" tests verify that `.md` command files contain the required Markdown headings, subagent prompt patterns, and cross-references. These are performed by reading the file content and checking for the presence of expected strings/patterns (e.g., `grep` for heading patterns like `## Step N:`, config key references like `test_stage.enabled`, and critic persona file paths). This can be done manually or via a simple shell script that checks for required patterns.

**YAML validation method:** YAML config files are validated by parsing them with a YAML parser and checking that the expected keys exist with the correct types and defaults. This can be done with `yq` or equivalent.

| User Story | Test Type | Test Description |
|-----------|-----------|-----------------|
| US-1 | Structural | Verify `commands/test.md` contains all 10 steps with correct headings and structure. |
| US-2 | Structural | Verify Step 3 includes Ralph Loop pattern (BUILD/REVIEW/ITERATE) with max iterations and human gate. |
| US-3 | Structural | Verify Step 4 references all `test_commands` keys and includes fix loop with re-run-all behavior. |
| US-4 | Structural | Verify Step 5 references coverage flag auto-detection and configurable thresholds. |
| US-5 | Structural | Verify Step 6 includes CI config file detection patterns and verification checklist. |
| US-6 | Structural | Verify Step 7 includes CD config file detection and report-only constraint. |
| US-7 | Structural | Verify Step 8 references execute.md Step 5 infrastructure and `smoke_test.enabled` check. |
| US-8 | Structural | Verify Step 9 references all 10 critics, parallel execution, and cumulative diff. |
| US-9 | Structural | Verify Step 10 includes all report sections with per-section verdicts and overall PASS/FAIL. |
| US-10 | YAML validation | Verify `pipeline-config-template.yaml` contains valid `test_stage` section with all documented options and correct defaults. |
| US-10 | YAML validation | Verify `test_commands` section includes `e2e` and `component` keys. |
| US-10 | YAML validation | Verify `validation.stages` includes `test` entry with correct critic list. |
| US-11 | Structural | Verify `fullpipeline.md` contains Stage 5 section, Gate 5, updated architecture diagram, updated orchestrator state, updated completion section, updated error recovery. |
| US-12 | Structural | Verify `test.md` Step 1 checks `test_stage.enabled` and exits if false. |
| All | Integration | Verify `commands/test.md` can be parsed as a valid Claude Code command file (proper heading structure, `$ARGUMENTS` reference). |
| All | Integration | Verify cross-references between `test.md`, `fullpipeline.md`, `pipeline-config-template.yaml`, and `WORKFLOW.md` are consistent (step numbers, config keys, critic lists). |

**Negative tests:**
- Verify `test.md` handles missing `test_stage` section gracefully (uses defaults).
- Verify `test.md` handles missing `test_commands.e2e` gracefully (skips E2E and reports "SKIPPED (not configured)").
- Verify `fullpipeline.md` handles `test_stage.enabled: false` by skipping Stage 5.

**Edge case tests:**
- Verify `test.md` handles empty diff (`git diff main..HEAD` returns nothing) — should report "No changed files detected. Test audit: N/A. Proceeding to critic validation only." and skip Steps 2-5.
- Verify `test.md` handles invalid/missing dev plan file in `$ARGUMENTS` — should report a clear error message ("Dev plan file not found: <path>") and exit without running any steps.
- Verify `test.md` handles a dev plan that references a PRD file that does not exist — should report a Warning ("PRD not found at <path>, skipping PRD Section 9 cross-reference") and continue with `test_requirements` patterns only.

## 10. Technical Context & Constraints

- **Project type:** CLI tool / Claude Code plugin — `.md` command files processed by Claude Code, YAML config parsed at runtime.
- **No runtime code:** The deliverables are Markdown command files and YAML config — no JavaScript, Python, or other executable code.
- **Pattern consistency:** Must follow the exact same patterns as `execute.md` for Ralph Loop, critic invocation, PR creation, human gates, and subagent prompting.
- **Config schema:** The `test_stage` section in `pipeline-config-template.yaml` must be documented with comments explaining each option and its default, matching the existing documentation style.
- **Critic invocation:** Critics are invoked by reading their persona `.md` files and running them as subagents. The `/test` stage uses the same mechanism as `/execute` Step 3c.
- **Git operations:** Cumulative diff is `git diff main..HEAD`. Branch creation follows `branch_pattern` from config.
- **File count:** This PRD produces changes to 5 files: 1 new (`commands/test.md`), 4 edits (`fullpipeline.md`, `pipeline-config-template.yaml`, `WORKFLOW.md`, `README.md`).

## 11. Success Metrics (with Tracking & Analytics Events)

No client-side tracking or analytics events are required (this is a developer CLI tool with no telemetry). Success is validated through manual verification:

| Metric | Measurement Method | Target |
|--------|-------------------|--------|
| SM-1: `/test` completes on default config | Run `/test` on a project with default `pipeline.config.yaml` and verify PASS report | Stage 5 produces PASS or correctly identifies failures |
| SM-2: `/fullpipeline` runs all 5 stages | Run `/fullpipeline` end-to-end and verify Stage 5 runs between Stage 4 and Completion | Gate 5 appears and Stage 5 results in final report |
| SM-3: Backward compatibility | Run `/fullpipeline` on a project without `test_stage` config section | Pipeline completes without errors; Stage 5 uses defaults |

## 12. Open Questions

| # | Question | Impact | Suggested Resolution |
|---|----------|--------|---------------------|
| OQ-1 | Should `/test` support running against a specific subset of test types (e.g., `/test --types=unit,integration`)? | P2 — would improve developer ergonomics for iterative testing | Defer to P2; for now, all configured test types always run. |
| OQ-2 | Should the CI audit step support auto-generating CI config files (not just fixing existing ones)? | P2 — useful for new projects | Defer; current scope is audit + fix-commented-jobs only. |
| OQ-3 | Should coverage thresholds be configurable per-file-pattern (e.g., `lib/**` = 90%, `scripts/**` = 70%)? | P2 — more granular control | Defer; single threshold is sufficient for V1. |

## 13. Dependencies & Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Large cumulative diff causes critic timeout | Medium | Low | Critics run in parallel; each operates on a bounded diff. If timeout occurs, escalate to user per existing pattern. |
| `test_commands` misconfigured in project config | Medium | Medium | `/test` validates that configured commands exist before running; reports clear error if command fails to execute. |
| CI config file detection misses non-standard CI systems | Low | Low | Detection covers GitHub Actions, GitLab CI, Jenkins, CircleCI, Azure Pipelines, and Bitbucket Pipelines. Non-standard systems are flagged as "No CI config detected" with a note to configure manually via `test_stage.ci_audit.config_paths`. |
| Coverage tool auto-detection fails for non-standard frameworks | Low | Medium | Falls back to running tests without coverage flag; reports as Warning. |
| Test generation (Step 3) produces low-quality tests that pass critics but don't catch real bugs | Medium | Low | QA + Dev critics review generated tests; human gate on PR provides final quality check. |
| Adding `/test` to `/fullpipeline` increases total pipeline duration | Low | High (expected) | `/test` is configurable; `test_stage.enabled: false` skips it entirely. Duration is bounded by `max_fix_iterations`. |

## 14. Timeline Estimate

| Deliverable | Complexity | Estimated Effort |
|------------|-----------|-----------------|
| `commands/test.md` (10 steps) | Complex | 2-3 hours |
| `fullpipeline.md` edits (Stage 5 integration) | Medium | 1-2 hours |
| `pipeline-config-template.yaml` edits | Simple | 30 minutes |
| `WORKFLOW.md` edits | Medium | 1 hour |
| `README.md` edits | Simple | 30 minutes |
| **Total** | | **5-7 hours** |
