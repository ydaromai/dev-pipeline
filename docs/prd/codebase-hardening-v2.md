# PRD: Dev-Pipeline Codebase Hardening v2

## Status: DRAFT
## Author: Generated by AI, owned by human
## Date: 2026-02-19

---

## 1. Problem Statement

A full 5-critic review of the dev-pipeline codebase returned FAIL verdicts from all 5 critics with 9 critical findings, 13 warnings, and 7 notes. Key issues fall into four areas: (1) credential safety gaps (.gitignore missing, broken error redaction, inconsistent redaction across scripts), (2) heavy code duplication across JIRA scripts (shared utilities copy-pasted 3x), (3) insufficient test coverage (~70% of exportable logic untested, including the highest-risk HTTP and issue-creation components), and (4) code quality issues (untestable script structure, Math.random() for IDs, magic numbers). These must be resolved so the pipeline meets the quality bar it enforces on downstream projects.

## 2. Target Users

- **Pipeline developers**: Maintaining and extending the dev-pipeline tooling
- **Pipeline users**: Engineers using `/fullpipeline`, `/plan2jira`, `/execute` in their projects

## 3. Goals

- All 5 critics pass on the codebase (zero critical findings)
- Credential files are gitignored and never at risk of accidental commit
- Error redaction works correctly and consistently across all scripts
- Shared utilities extracted — no copy-pasted logic across files
- Core business logic (JiraClient, IssueCreator) has automated test coverage
- All scripts are structured for testability

## 4. Non-Goals (Explicitly Out of Scope)

- Adding new pipeline features or commands
- Changing the pipeline workflow or critic agent behavior
- Adding integration tests that require a live JIRA instance
- Refactoring the MarkdownParser in markdown-to-adf.js (it's a different parser with different purpose)
- Adding a CI/CD pipeline (tracked separately)

## 5. User Stories

### US-1: Credential Safety
**As a** pipeline user, **I want** credentials excluded from git and properly redacted in all error output, **so that** API tokens are never accidentally committed or leaked in logs.

**Acceptance Criteria:**
- [x] AC 1.1: `.gitignore` exists at repo root and includes `.env.jira`, `jira-issue-mapping.json`, `.jira-import-history.json`, `node_modules/` — ALREADY DONE
- [x] AC 1.2: `.env.example` file exists at `scripts/jira/.env.example` with placeholder values for all 4 required env vars — ALREADY DONE
- [ ] AC 1.3: Error redaction in `jira-import.js` uses safe string replacement (not `new RegExp()` on Base64 strings) to avoid regex metacharacter bugs with `+`, `/`, `=`
- [ ] AC 1.4: `transition-issue.js` redacts credentials from all error output (matching `jira-import.js` behavior)
- [ ] AC 1.5: `cleanup-import.js` redacts credentials from all error output
- [ ] AC 1.6: No credentials appear in any error message when running any script against an invalid JIRA URL

### US-2: Shared Module Extraction
**As a** developer, **I want** shared utilities consolidated into reusable modules, **so that** bug fixes and improvements only need to be applied once.

**Acceptance Criteria:**
- [ ] AC 2.1: `loadEnvJira()` exists in a single shared module (`scripts/jira/lib/env.js`) and is imported by all 3 scripts
- [ ] AC 2.2: `retryWithBackoff()` and `sleep()` exist in a single shared module (`scripts/jira/lib/retry.js`) and are imported by all scripts that need retry
- [ ] AC 2.3: `JiraClient` class exists in a single shared module (`scripts/jira/lib/jira-client.js`) with retry logic and error redaction, imported by all 3 scripts
- [ ] AC 2.4: Time estimate parsing logic extracted into a shared function (not duplicated in createStory/createTask/createSubtask)
- [ ] AC 2.5: `test-parser.js` is removed (dead code — its MarkdownParser is an outdated subset of the canonical one in `jira-import.js`)
- [ ] AC 2.6: All 3 scripts still work correctly after extraction (verified by running `node <script> --help`)

### US-3: Script Testability
**As a** developer, **I want** all scripts structured for unit testing, **so that** core logic can be tested without triggering side effects.

**Acceptance Criteria:**
- [ ] AC 3.1: `transition-issue.js` exports its core functions (`transition`, `addComment`, `getTransitions`) and guards top-level execution with an `isDirectRun` check
- [ ] AC 3.2: `cleanup-import.js` exports its core functions (`deleteByBatch`, `deleteByFile`, `listImports`) and guards top-level execution with an `isDirectRun` check
- [ ] AC 3.3: The `isDirectRun` pattern in `jira-import.js` is fixed to use `fileURLToPath(import.meta.url) === path.resolve(process.argv[1])` instead of the fragile `endsWith` check
- [ ] AC 3.4: Importing any script as a module does not trigger side effects (no CLI parsing, no API calls)

### US-4: Comprehensive Test Coverage
**As a** developer, **I want** unit tests for all core business logic, **so that** regressions are caught before they reach JIRA.

**Acceptance Criteria:**
- [ ] AC 4.1: Unit tests exist for the shared `JiraClient` class covering: successful request, HTTP error with redaction, retry on 429, retry on 503, max retries exceeded
- [ ] AC 4.2: Unit tests exist for time estimate parsing covering: "8 hours", "2 days", "30 minutes", "~4 hours", "2-3 days" (range takes lower bound), empty/null input
- [ ] AC 4.3: Unit tests exist for `getHeadingId()` covering all heading formats (EPIC, STORY, TASK, SUBTASK)
- [ ] AC 4.4: Unit tests exist for `planItemIdFromIssueId()` and `summaryWithPlanId()`
- [ ] AC 4.5: Unit tests exist for error redaction covering: normal Base64, Base64 with `+`, `/`, `=` characters
- [ ] AC 4.6: All tests pass with `npm test` in `scripts/jira/`
- [ ] AC 4.7: Tests use `node:test` with zero external dependencies

### US-5: Code Quality Polish
**As a** developer, **I want** code quality issues resolved, **so that** the codebase follows its own Dev Critic standards.

**Acceptance Criteria:**
- [ ] AC 5.1: `generateBatchId` uses `crypto.randomBytes()` or `crypto.randomUUID()` instead of `Math.random()`
- [ ] AC 5.2: Retry configuration uses named constants (`MAX_RETRIES`, `RETRY_BASE_DELAY_MS`) instead of magic numbers
- [ ] AC 5.3: JIRA README troubleshooting curl example does not show credentials on command line (use `-u email` with password prompt or note the security caveat)

## 6. Functional Requirements

### Must Have (P0)

- Create `.gitignore` with credential/generated file exclusions
- Fix broken `new RegExp()` error redaction in `jira-import.js`
- Add error redaction to `transition-issue.js` and `cleanup-import.js`
- Extract `loadEnvJira` into shared module
- Extract `retryWithBackoff`/`sleep` into shared module
- Extract `JiraClient` into shared module with retry + redaction
- Extract time estimate parsing into shared function
- Remove dead `test-parser.js`

### Should Have (P1)

- Refactor `transition-issue.js` for testability (export functions, isDirectRun guard)
- Refactor `cleanup-import.js` for testability (export functions, isDirectRun guard)
- Fix fragile `isDirectRun` in `jira-import.js`
- Create `.env.jira.example` with placeholder values
- Unit tests for shared `JiraClient` (with mocked fetch)
- Unit tests for time estimate parsing
- Unit tests for `getHeadingId`, `planItemIdFromIssueId`, `summaryWithPlanId`
- Unit tests for error redaction

### Nice to Have (P2)

- Replace `Math.random()` with `crypto.randomBytes()` in `generateBatchId`
- Named constants for retry configuration
- Fix curl example in JIRA README

## 7. Acceptance Criteria (Consolidated)

### P0 — Must Pass
- [x] AC 1.1: `.gitignore` covers credentials and generated files — ALREADY DONE
- [ ] AC 1.3: Error redaction uses safe string replacement (not broken RegExp)
- [ ] AC 1.4: `transition-issue.js` redacts credentials
- [ ] AC 1.5: `cleanup-import.js` redacts credentials
- [ ] AC 2.1: `loadEnvJira` in shared module
- [ ] AC 2.2: `retryWithBackoff`/`sleep` in shared module
- [ ] AC 2.3: `JiraClient` in shared module with retry + redaction
- [ ] AC 2.4: Time estimate parsing extracted
- [ ] AC 2.5: `test-parser.js` removed
- [ ] AC 2.6: All scripts work after extraction

### P1 — Should Pass
- [x] AC 1.2: `.env.example` exists — ALREADY DONE
- [ ] AC 1.6: No credentials in any error output
- [ ] AC 3.1: `transition-issue.js` exports functions, isDirectRun guard
- [ ] AC 3.2: `cleanup-import.js` exports functions, isDirectRun guard
- [ ] AC 3.3: Robust `isDirectRun` in `jira-import.js`
- [ ] AC 3.4: No side effects on import
- [ ] AC 4.1: JiraClient tests (success, error+redaction, retry 429/503, max exceeded)
- [ ] AC 4.2: Time estimate parsing tests
- [ ] AC 4.3: `getHeadingId` tests
- [ ] AC 4.4: `planItemIdFromIssueId`/`summaryWithPlanId` tests
- [ ] AC 4.5: Error redaction tests (Base64 with metacharacters)
- [ ] AC 4.6: All tests pass with `npm test`
- [ ] AC 4.7: Tests use `node:test`, zero deps

### P2 — Nice to Have
- [ ] AC 5.1: `crypto.randomBytes()` instead of `Math.random()`
- [ ] AC 5.2: Named constants for retry config
- [ ] AC 5.3: README curl example fixed

## 8. Non-Functional Requirements

- **Security**: No credentials in git history, no secrets in error output, redaction works with all Base64 variants
- **Reliability**: Consistent retry logic across all scripts via shared module
- **Maintainability**: Single source of truth for shared utilities, all scripts testable
- **Consistency**: Same JiraClient behavior (retry, redaction) everywhere

## 9. Testing Strategy

| User Story | Unit | Integration | UI | E2E | Notes |
|-----------|------|-------------|-----|-----|-------|
| US-1 | Yes | No | No | No | Test error redaction with Base64 edge cases |
| US-2 | Yes | No | No | No | Verify shared modules work; run existing tests to catch regressions |
| US-3 | Yes | No | No | No | Verify imports don't trigger side effects |
| US-4 | Yes | No | No | No | Mock fetch for JiraClient tests |
| US-5 | No | No | No | No | Manual verification |

## 10. Technical Context & Constraints

- Node.js >= 18 (uses native `fetch`, `node:test`, `node:crypto`)
- No external test framework — use `node:test` built-in module
- Scripts live in `scripts/jira/` with shared code in `scripts/jira/lib/`
- ESM modules throughout (`"type": "module"` in package.json)
- Must maintain backward compatibility — scripts are called by pipeline commands with specific arguments
- **Execution parallelism**: The dev plan MUST maximize parallel execution. Tasks that do not have a true data dependency on each other should be placed in the same parallel group. The default bias is "as parallel as possible" — only add a dependency when a task literally cannot start without another's output (e.g., shared modules must exist before scripts can import them, but .gitignore, .env.example, and README fixes can all run in parallel with each other and with shared module extraction)

## 11. Success Metrics

| Metric | Target | Measurement Method |
|--------|--------|--------------------|
| Critic findings resolved | 0 critical, 0 warnings | Re-run all 5 critics |
| Scripts execute without errors | 100% | `node <script> --help` for each |
| Test pass rate | 100% | `npm test` in scripts/jira/ |
| No credentials at risk | 0 exposed | `.gitignore` covers all sensitive files |
| Code duplication | 0 copy-pasted utilities | No shared function exists in more than one file |

## 12. Open Questions

- None — all findings are well-defined with clear fix paths

## 13. Dependencies & Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Shared module extraction breaks imports | Medium | Low | Run all existing tests after extraction |
| Refactored scripts change CLI behavior | Medium | Low | Test with `--help` and `--dry-run` flags |
| Mocking fetch in tests is complex | Low | Medium | Use simple spy pattern, no external mock library |
| Removing test-parser.js breaks someone's workflow | Low | Very Low | It's a manual testing script not referenced by any command |

## 14. Timeline Estimate

- Phase 1: Credential safety + shared module extraction (P0)
- Phase 2: Script testability + test coverage (P1)
- Phase 3: Code quality polish (P2)
